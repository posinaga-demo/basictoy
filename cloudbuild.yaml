 steps:

 # build the webapp container image
 - name: 'gcr.io/cloud-builders/docker'
   args: ['build', '-t', 'gcr.io/$PROJECT_ID/basictoy:$COMMIT_SHA', '.']

 # push the webapp container image to Container Registry
 - name: 'gcr.io/cloud-builders/docker'
   args: ['push', 'gcr.io/$PROJECT_ID/basictoy:$COMMIT_SHA']

# build the integration load-tests container image
 - name: 'gcr.io/cloud-builders/docker'
   args: ['build', '-f', 'load-tests/Dockerfile', '-t', 'gcr.io/$PROJECT_ID/basictoy-lt:$COMMIT_SHA', '.']

 # push the integration load-tests container image to Container Registry
 - name: 'gcr.io/cloud-builders/docker'
   args: ['push', 'gcr.io/$PROJECT_ID/basictoy-lt:$COMMIT_SHA']

 # Deploy webapp to a temp service
 - name: 'gcr.io/cloud-builders/gcloud'
   args: ['run', 'deploy', 'basictoy-$COMMIT_SHA', '--image', 'gcr.io/$PROJECT_ID/basictoy:$COMMIT_SHA', '--region', 'us-east4', '--platform', 'managed', '--port', '3000', '--allow-unauthenticated']

# capture the URL of the webapp service
 - name: 'gcr.io/cloud-builders/gcloud'
   entrypoint: 'bash'
   args: 
    - '-c'
    - |
      gcloud run services describe basictoy-$COMMIT_SHA --platform managed --region us-east4 | grep Traffic | cut -c10-9999 > _webapp_service_url
      cat captured web app service url: $(cat _webapp_service_url)

#      echo "test-$(date +%s)" > _cluster-name
#      gcloud container clusters create $(cat _cluster-name)

# Run integration load-tests
 - name: 'gcr.io/$PROJECT_ID/basictoy-lt:$COMMIT_SHA'
   args: ['locust','--host','https://google.com','--no-web','--clients','10','--hatch-rate','7','--run-time','30s']
#   env: 
#   - 'TARGET_URL=https://google.com'